# 数据库管理指南

## 概述

本文档详细介绍了"一日三餐"项目的数据库管理操作，包括用户数据查看、删除操作和数据库清理等功能。

## 目录

- [数据存储架构](#数据存储架构)
- [用户数据查看](#用户数据查看)
- [数据删除方案](#数据删除方案)
- [清理脚本使用](#清理脚本使用)
- [安全注意事项](#安全注意事项)
- [食材管理功能测试](#食材管理功能测试)
- [常见问题](#常见问题)

---

## 数据存储架构

### 数据库配置
- **数据库类型**: MongoDB
- **默认连接**: `mongodb://localhost:27017/eatracker`
- **主要集合**: users, ingredients, recipes

### 用户数据结构
```javascript
{
  "_id": ObjectId("..."),
  "username": "用户名（唯一）",
  "password": "$2b$10$...",  // bcrypt加密后的密码
  "name": "真实姓名",
  "role": "parent" | "child",
  "age": 数字,
  "height": 数字（cm）,
  "weight": 数字（kg）,
  "bmi": 数字（自动计算）,
  "dailyCalorieNeeds": 数字,
  "nutritionNeeds": {
    "protein": 数字,
    "carbs": 数字,
    "fat": 数字,
    "fiber": 数字
  },
  "lastUpdated": Date,
  "createdAt": Date,
  "updatedAt": Date
}
```

### 食材数据结构
```javascript
{
  "_id": ObjectId("..."),
  "userId": ObjectId("..."),  // 关联的用户ID
  "name": "食材名称",
  "category": "食材分类",
  "quantity": 数字,
  "unit": "单位",
  "nutrition": {
    "calories": 数字,  // 热量 (kcal/100g)
    "protein": 数字,   // 蛋白质 (g/100g)
    "carbs": 数字,     // 碳水化合物 (g/100g)
    "fat": 数字,       // 脂肪 (g/100g)
    "fiber": 数字      // 纤维 (g/100g)
  },
  "expiryDate": Date,
  "createdAt": Date,
  "updatedAt": Date
}
```

### 密码安全
- 使用 `bcrypt` 进行单向加密
- 盐值轮数: 10
- **重要**: 原始密码无法从数据库中恢复

---

## 用户数据查看

### 1. 使用MongoDB命令行工具

#### 连接数据库
```bash
mongo eatracker
```

#### 基本查询命令
```javascript
// 查看所有用户
db.users.find().pretty()

// 查看用户数量
db.users.count()

// 查找特定用户
db.users.findOne({username: "用户名"})

// 查看所有集合
show collections

// 数据库统计
db.stats()

// 查看食材数据
db.ingredients.find().pretty()

// 查看特定用户的食材
db.ingredients.find({userId: ObjectId("用户ID")}).pretty()
```

#### 常用操作示例
```bash
# 快速查看所有用户
mongo eatracker --eval "db.users.find().pretty()"

# 查看用户数量
mongo eatracker --eval "db.users.count()"

# 查看特定用户
mongo eatracker --eval "db.users.findOne({username: 'mayufeng'})"

# 查看食材统计
mongo eatracker --eval "db.ingredients.count()"
```

### 2. 数据库概念说明

**重要区别**:
- `数据库 (Database)`: eatracker
- `集合 (Collection)`: users, ingredients, recipes
- `文档 (Document)`: 集合中的单条记录

**正确操作流程**:
```bash
> use eatracker        # 切换到eatracker数据库
> show collections     # 显示所有集合
> db.users.find()      # 查询users集合中的文档
> db.ingredients.find() # 查询ingredients集合中的文档
```

**错误操作示例**:
```bash
> use users            # ❌ 错误：这会切换到"users"数据库，而不是访问users集合
```

---

## 数据删除方案

### 1. 手动删除（开发调试用）

#### 删除特定用户
```bash
mongo eatracker --eval "db.users.deleteOne({username: '用户名'})"
```

#### 删除所有用户
```bash
mongo eatracker --eval "db.users.deleteMany({})"
```

#### 删除特定用户的食材
```bash
mongo eatracker --eval "db.ingredients.deleteMany({userId: ObjectId('用户ID')})"
```

#### 删除整个集合
```bash
mongo eatracker --eval "db.users.drop()"
mongo eatracker --eval "db.ingredients.drop()"
```

### 2. API删除（推荐用于生产环境）

#### 用户自删除账户
```http
DELETE /api/users/profile
Authorization: Bearer <JWT_TOKEN>
```

#### 删除食材
```http
DELETE /api/ingredients/:ingredientId
Authorization: Bearer <JWT_TOKEN>
```

#### 特点
- ✅ 需要用户认证
- ✅ 使用数据库事务
- ✅ 级联删除逻辑
- ✅ 操作日志记录

---

## 清理脚本使用

### 脚本位置
```
backend/scripts/cleanup-database.js
backend/scripts/test-ingredient-api.js
backend/scripts/demo-ingredient-features.js
```

### 基本用法

#### 1. 查看帮助信息
```bash
cd backend
node scripts/cleanup-database.js
```

#### 2. 查看数据库统计信息
```bash
node scripts/cleanup-database.js stats
```
**输出示例**:
```
MongoDB 连接成功: localhost

=== 数据库统计信息 ===
users: 2 个文档
ingredients: 3 个文档
```

#### 3. 删除所有用户和食材
```bash
node scripts/cleanup-database.js users
```
**输出示例**:
```
MongoDB 连接成功: localhost
清理所有用户数据...
删除了 3 个食材
删除了 2 个用户

=== 数据库统计信息 ===
users: 0 个文档
ingredients: 0 个文档
```

#### 4. 删除指定用户和其食材
```bash
node scripts/cleanup-database.js user testuser
```
**输出示例**:
```
MongoDB 连接成功: localhost
清理用户 testuser 的数据...
删除了用户 testuser 的 2 个食材
删除了用户 testuser

=== 数据库统计信息 ===
users: 1 个文档
ingredients: 1 个文档
```

#### 5. 清空所有数据
```bash
node scripts/cleanup-database.js all
```

### 脚本功能详解

| 命令 | 功能 | 适用场景 |
|------|------|----------|
| `stats` | 显示数据库统计信息 | 日常监控、操作前确认 |
| `users` | 删除所有用户和食材 | 清理测试用户、重置用户系统 |
| `user <name>` | 删除指定用户和其食材 | 清理特定测试账户 |
| `all` | 删除所有集合数据 | 完全重置数据库、重新开始开发 |

---

## 安全注意事项

### 1. 密码安全
- ❌ **无法查看原始密码**: bcrypt为单向加密
- ✅ **密码重置**: 如需更改密码，只能重置新密码
- ✅ **测试验证**: 可以测试密码是否匹配

### 2. 数据删除安全
- ⚠️ **删除操作不可逆**: 删除前请确认数据
- ✅ **生产环境**: 使用API删除，有认证和日志
- ✅ **开发环境**: 可以使用脚本快速清理

### 3. 环境配置
```bash
# 确保在正确的环境中操作
echo $MONGODB_URI

# 备份重要数据（生产环境）
mongodump --db eatracker --out backup/
```

### 4. 级联删除设计
当删除用户时，系统会自动清理相关数据：
- ✅ 用户基本信息（用户名、密码、姓名等）
- ✅ 身体数据（身高、体重、BMI等）
- ✅ 用户食材（所有关联的食材记录）
- 🔄 营养记录（未来扩展）
- 🔄 个人菜谱（未来扩展）
- 🔄 饮食日志（未来扩展）

---

## 食材管理功能测试

### API端点测试

#### 1. 用户认证
```bash
# 注册用户
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser", "password": "test123", "name": "测试用户"}'

# 登录获取token
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser", "password": "test123"}'
```

#### 2. 食材管理操作
```bash
# 设置token变量
export TOKEN="your_jwt_token_here"

# 获取食材列表
curl -X GET http://localhost:5000/api/ingredients \
  -H "Authorization: Bearer $TOKEN"

# 添加食材
curl -X POST http://localhost:5000/api/ingredients \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "苹果",
    "category": "水果",
    "quantity": 5,
    "unit": "个",
    "nutrition": {
      "calories": 52,
      "protein": 0.3,
      "carbs": 14,
      "fat": 0.2,
      "fiber": 2.4
    },
    "expiryDate": "2024-12-31T00:00:00.000Z"
  }'

# 更新食材
curl -X PUT http://localhost:5000/api/ingredients/INGREDIENT_ID \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"quantity": 8}'

# 删除食材
curl -X DELETE http://localhost:5000/api/ingredients/INGREDIENT_ID \
  -H "Authorization: Bearer $TOKEN"
```

### 自动化测试脚本

#### 运行完整测试
```bash
cd backend
npm install axios  # 安装测试依赖
node scripts/test-ingredient-api.js
```

#### 测试脚本功能
- ✅ 用户注册/登录
- ✅ 食材CRUD操作
- ✅ 数据验证
- ✅ 权限检查
- ✅ 错误处理

#### 预期输出
```
=== 食材API测试开始 ===

1. 注册测试用户...
✅ 用户注册成功

2. 获取食材列表...
✅ 获取食材列表成功，当前有 0 个食材

3. 添加食材...
✅ 添加食材成功: 苹果

4. 再次获取食材列表...
✅ 获取食材列表成功，当前有 1 个食材

5. 更新食材...
✅ 更新食材成功，新数量: 8

6. 获取单个食材...
✅ 获取单个食材成功: 苹果

7. 删除食材...
✅ 删除食材成功

8. 确认删除...
✅ 确认删除成功，当前有 0 个食材

=== 所有测试通过！ ===
```

### 前端界面测试

#### 启动应用
```bash
# 启动后端
cd backend
npm run dev

# 启动前端（新终端）
cd frontend
npm start
```

#### 测试流程
1. **用户登录** - 访问 http://localhost:3000/login
2. **进入食材管理** - 点击侧边栏"食材管理"
3. **添加食材** - 点击"添加食材"按钮
4. **填写表单** - 完整填写食材信息
5. **查看列表** - 验证食材显示和状态
6. **编辑/删除** - 测试编辑和删除功能

#### 功能验证
- ✅ 表单验证（必填字段、数据格式）
- ✅ 用户体验（加载状态、错误提示）
- ✅ 数据持久化（刷新页面数据保持）
- ✅ 过期状态（新鲜/即将过期/已过期）
- ✅ 数据隔离（不同用户数据独立）

---

## 常见问题

### Q1: 忘记了测试用户的密码怎么办？
**A**: bcrypt加密的密码无法解密。建议：
1. 删除测试用户重新注册
2. 或者尝试常用密码（如：123456、password、用户名等）

### Q2: 删除用户后发现食材数据还在怎么办？
**A**: 检查删除方式：
1. 使用API删除：`DELETE /api/users/profile` - 会自动级联删除
2. 使用脚本删除：`node scripts/cleanup-database.js user username` - 会删除相关食材
3. 手动数据库删除：需要分别删除用户和食材

### Q3: 食材添加失败，提示"未授权"怎么办？
**A**: 检查认证状态：
1. 确认用户已登录且token有效
2. 检查token是否正确设置在请求头中
3. 确认后端服务正常运行
4. 检查浏览器控制台是否有错误信息

### Q4: 如何测试食材过期状态？
**A**: 
1. 添加过期日期为今天的食材（即将过期）
2. 添加过期日期为昨天的食材（已过期）
3. 添加过期日期为未来的食材（新鲜）
4. 查看列表中的状态标识是否正确

### Q5: 生产环境如何安全删除用户？
**A**: 
1. 使用API接口: `DELETE /api/users/profile`
2. 需要用户JWT认证
3. 操作会记录日志
4. 使用数据库事务确保一致性

### Q6: 如何备份数据？
**A**: 
```bash
# 备份整个数据库
mongodump --db eatracker --out backup/

# 恢复数据库
mongorestore --db eatracker backup/eatracker/

# 备份特定集合
mongodump --db eatracker --collection users --out backup/
mongodump --db eatracker --collection ingredients --out backup/
```

### Q7: 清理脚本连接失败怎么办？
**A**: 
1. 确认MongoDB服务是否启动: `brew services start mongodb-community`
2. 检查连接字符串: 默认 `mongodb://localhost:27017/eatracker`
3. 确认.env文件配置正确
4. 检查防火墙设置

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0 | 2025-08-12 | 初始版本，基础数据库管理功能 |
| v1.1 | 2025-08-12 | 添加食材管理功能和测试指南 |

---

## 相关文档

- [项目README](../README.md)
- [数据库快速参考](./数据库快速参考.md)
- [API文档](./API文档.md) (待创建)
- [部署指南](./部署指南.md) (待创建)

---

*最后更新: 2025年8月12日* 